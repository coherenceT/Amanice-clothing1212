<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AMA-NICE CLOTHING</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent: #8B4513;
            --accent-dark: #a05a2c;
            --white: #FFFFFF;
            --cream: #FFF8F0;
            --dark: #333333;
            --silver: #C0C0C0;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--cream);
            color: var(--dark);
            line-height: 1.6;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--white) 0%, var(--silver) 100%);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-header h1 {
            color: var(--accent);
            font-size: 1.5rem;
            margin: 0;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary {
            background: var(--silver);
            color: var(--dark);
        }

        .btn-danger {
            background: #ff4444;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-section, .products-section {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .section-title {
            color: var(--accent);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--silver);
            border-radius: var(--radius);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-group small {
            color: #666;
            font-size: 0.9rem;
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
            margin-top: 1rem;
            width: 100%;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius);
            border: 2px dashed var(--silver);
            display: none;
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .image-preview.show {
            display: block;
        }

        .image-preview-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }

        .image-preview-remove:hover {
            background: rgba(255, 68, 68, 1);
            transform: scale(1.1);
        }

        .image-preview-remove:active {
            transform: scale(0.95);
        }

        .image-preview.show ~ .image-preview-remove,
        .image-preview-container:has(.image-preview.show) .image-preview-remove {
            display: flex;
        }

        .stock-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, var(--cream) 0%, #ffffff 100%);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            border: 2px solid var(--silver);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: var(--accent);
        }

        .stock-item span {
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-item span::before {
            content: 'üì¶';
            font-size: 1.2rem;
        }

        .stock-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-shrink: 0;
            min-width: fit-content;
        }

        .stock-controls button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.5rem;
            min-width: 50px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            touch-action: manipulation;
            flex-shrink: 0;
            position: relative;
        }

        .stock-controls button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        }

        .stock-controls button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        .stock-controls button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stock-controls .btn-increment {
            background: linear-gradient(135deg, #25A525 0%, #1d7a1d 100%);
            color: white;
        }

        .stock-controls .btn-increment:hover {
            background: linear-gradient(135deg, #1d7a1d 0%, #25A525 100%);
        }

        .stock-controls .btn-decrement {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
        }

        .stock-controls .btn-decrement:hover {
            background: linear-gradient(135deg, #cc0000 0%, #ff4444 100%);
        }

        .products-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .product-item {
            background: var(--cream);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent);
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-item-number {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: var(--accent);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            z-index: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .stock-quantity-display {
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .shoe-stock-quantity {
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .product-item-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .product-item-info {
            flex: 1;
        }

        .product-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--radius);
            margin-right: 1rem;
        }

        .product-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .product-item-actions button {
            padding: 0.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-edit {
            background: #4285F4;
            color: white;
        }

        .btn-delete {
            background: #ff4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: var(--accent);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--dark);
        }

        .stock-list {
            margin-top: 1rem;
        }

        .stock-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, var(--cream) 100%);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            border: 2px solid var(--silver);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stock-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: var(--accent);
        }

        .stock-entry span {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .shoes-brand-section {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--cream);
            border-radius: var(--radius);
            display: none;
        }

        .shoes-brand-section.show {
            display: block;
        }

        .brand-stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, var(--cream) 100%);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            border: 2px solid var(--silver);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .brand-stock-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: var(--accent);
        }

        .brand-stock-item span {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .filter-section {
            background: var(--cream);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .filter-section label {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .filter-section input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .filter-section input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 2px solid var(--silver);
            border-radius: var(--radius);
        }

        .filter-section input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }

        .product-count-display {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--cream) 0%, #ffffff 100%);
            border-radius: var(--radius);
            border: 2px solid var(--accent);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 6px rgba(139, 69, 19, 0.15);
        }

        .product-count-display::before {
            content: 'üìä';
            font-size: 1.2rem;
        }

        .stock-count-display {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--cream) 0%, #ffffff 100%);
            border-radius: var(--radius);
            border: 2px solid var(--accent);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 6px rgba(139, 69, 19, 0.15);
        }

        .stock-count-display::before {
            content: 'üì¶';
            font-size: 1.2rem;
        }

        /* Upload Progress Styles */
        .upload-progress-container {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--cream) 0%, #ffffff 100%);
            border-radius: var(--radius);
            border: 2px solid var(--accent);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        .upload-progress-container.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upload-progress-header h4 {
            color: var(--accent);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-progress-header h4 i {
            animation: spin 1s linear infinite;
        }

        .upload-progress-bar-wrapper {
            width: 100%;
            height: 24px;
            background: var(--silver);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0.75rem;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 50%, var(--accent) 100%);
            background-size: 200% 100%;
            border-radius: 12px;
            transition: width 0.3s ease;
            position: relative;
            animation: progressShine 2s linear infinite;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.4);
        }

        @keyframes progressShine {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .upload-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .upload-progress-percentage {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-progress-status {
            text-align: center;
            color: var(--dark);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .upload-progress-status i {
            margin-right: 0.5rem;
        }

        .upload-progress-status.uploading {
            color: var(--accent);
        }

        .upload-progress-status.saving {
            color: #4285F4;
        }

        .upload-progress-status.complete {
            color: #25A525;
        }

        /* Loading Overlay */
        .upload-loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .upload-loading-overlay.active {
            display: flex;
        }

        .upload-loading-content {
            background: white;
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .upload-loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--silver);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        .upload-loading-content h3 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .upload-loading-content p {
            color: var(--dark);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-loading-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .admin-header {
                padding: 0.75rem 1rem;
            }

            .admin-header h1 {
                font-size: 1.2rem;
                flex-basis: 100%;
                text-align: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
                gap: 0.5rem;
            }

            .header-actions .btn {
                padding: 0.625rem 1rem;
                font-size: 0.9rem;
                flex: 1;
                min-width: 120px;
                max-width: 200px;
            }

            .tab-buttons-container button {
                min-width: 100% !important;
                width: 100% !important;
            }

            .filter-section > div:first-child {
                grid-template-columns: 1fr !important;
            }

            .filter-section > div:last-child {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start !important;
            }

            .stock-management {
                grid-template-columns: 1fr;
            }

            .stock-controls button {
                min-width: 56px;
                width: 56px;
                height: 56px;
                font-size: 1.75rem;
                padding: 0.875rem 1.5rem;
            }

            .search-input {
                width: 100% !important;
                min-width: 0 !important;
            }

            .search-btn-text {
                display: inline;
            }

            .stock-item {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .stock-item span {
                text-align: center;
            }

            .stock-controls {
                justify-content: center;
                width: 100%;
            }

            .stock-entry {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .stock-entry .stock-controls {
                justify-content: center;
            }

            .brand-stock-item {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .brand-stock-item button {
                width: 100%;
            }

            .upload-progress-container {
                padding: 1rem;
            }

            .upload-progress-percentage {
                font-size: 1.25rem;
            }

            .form-section, .products-section {
                padding: 1.5rem;
            }

            .section-title {
                font-size: 1.25rem;
            }

            .btn {
                padding: 0.875rem 1.25rem;
                font-size: 1rem;
                min-height: 48px;
            }

            .product-item {
                padding: 1rem;
            }

            .product-item-header {
                flex-direction: column;
                gap: 1rem;
            }

            .product-item-image {
                width: 100%;
                height: auto;
                max-height: 200px;
                margin-right: 0;
            }

            .product-item-actions {
                width: 100%;
                justify-content: stretch;
            }

            .product-item-actions button {
                flex: 1;
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .modal-content {
                padding: 1.5rem;
                width: 95%;
                margin: 1rem;
            }

            .image-preview-remove {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
                top: 5px;
                right: 5px;
            }

            .search-input {
                width: 100% !important;
                min-width: 0 !important;
                padding: 0.75rem !important;
                font-size: 1rem !important;
            }

            .search-btn {
                min-width: auto !important;
                padding: 0.75rem 1rem !important;
            }

            .search-btn-text {
                display: none;
            }

            .product-count-display {
                font-size: 0.95rem;
                padding: 0.625rem 0.875rem;
                width: 100%;
                justify-content: center;
                text-align: center;
            }

            .stock-count-display {
                font-size: 0.95rem;
                padding: 0.625rem 0.875rem;
                width: 100%;
                justify-content: center;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            .admin-header h1 {
                font-size: 1rem;
            }

            .header-actions .btn {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }

            .container {
                padding: 0.75rem;
            }

            .form-section, .products-section {
                padding: 1rem;
            }

            .stock-controls button {
                min-width: 60px;
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }

            .search-btn-text {
                display: none;
            }

            .product-count-display {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }

            .stock-count-display {
                font-size: 0.9rem;
                padding: 0.5rem 0.75rem;
            }

            .btn {
                padding: 1rem 1.5rem;
                font-size: 1.1rem;
                min-height: 52px;
            }

            /* Tab buttons mobile optimization */
            .tab-buttons-container {
                flex-direction: column !important;
            }

            .tab-buttons-container button {
                width: 100% !important;
                min-width: 100% !important;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Check if logged in -->
    <script>
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>

    <div class="admin-header">
        <h1><i class="fas fa-user-shield"></i> Admin Dashboard</h1>
        <div class="header-actions">
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-store"></i> Back to Store
            </a>
            <button class="btn btn-danger" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- Tabs for different product types -->
        <div style="margin-bottom: 2rem; background: white; padding: 1rem; border-radius: var(--radius); box-shadow: var(--shadow);">
            <div class="tab-buttons-container" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" id="tabRegular" onclick="switchTab('regular')" style="flex: 1; min-width: 150px;">
                    <i class="fas fa-tshirt"></i> Regular Products
                </button>
                <button class="btn btn-secondary" id="tabSneakers" onclick="switchTab('sneakers')" style="flex: 1; min-width: 150px;">
                    <i class="fas fa-shoe-prints"></i> Add Sneakers
                </button>
                <button class="btn btn-secondary" id="tabKidsPacks" onclick="switchTab('kidspacks')" style="flex: 1; min-width: 150px;">
                    <i class="fas fa-gift"></i> Add Kids Packs
                </button>
                <button class="btn btn-secondary" id="tabRecentlyAdded" onclick="switchTab('recently-added')" style="flex: 1; min-width: 150px;">
                    <i class="fas fa-clock"></i> Recently Added
                </button>
            </div>
        </div>

        <div class="admin-grid">
            <!-- Add Product Form - Regular Products -->
            <div class="form-section" id="regularProductForm">
                <h2 class="section-title">Add New Product</h2>
                <form id="productForm">
                    <div class="form-group">
                        <label for="productImage">Product Image *</label>
                        <input type="file" id="productImage" accept="image/*" required>
                        <small>Upload a photo of your product</small>
                        <div class="image-preview-container">
                        <img id="imagePreview" class="image-preview" alt="Preview">
                            <button type="button" class="image-preview-remove" onclick="removeImagePreview('imagePreview', 'productImage')" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group" style="background: var(--cream); padding: 1.5rem; border-radius: var(--radius); border: 2px solid var(--accent);">
                        <label for="productCategory" style="font-size: 1.1rem; font-weight: 700; color: var(--accent); display: block; margin-bottom: 0.75rem;">
                            <i class="fas fa-tags"></i> Select Product Category *
                        </label>
                        <select id="productCategory" required style="font-size: 1.1rem; padding: 1rem; font-weight: 600; border: 2px solid var(--accent); background: var(--white);">
                            <option value="">‚ö†Ô∏è Please Select a Category</option>
                            <option value="men">üëï Men's Collection</option>
                            <option value="women">üëö Women's Collection</option>
                            <option value="kids">üë∂ Kids Collection</option>
                        </select>
                        <small style="display: block; margin-top: 0.5rem; color: var(--dark-silver); font-weight: 600;">
                            <i class="fas fa-info-circle"></i> This determines which section the product appears in on the store page
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="productName">Product Name *</label>
                        <input type="text" id="productName" placeholder="e.g., Classic Blue Jeans, Red Hoodie" required>
                        <small>The specific name of this product (e.g., 'Classic Blue Jeans' instead of just 'Jeans')</small>
                    </div>

                    <div class="form-group" style="background: var(--cream); padding: 1.5rem; border-radius: var(--radius); border: 2px solid var(--accent);">
                        <label for="productType" style="font-size: 1.1rem; font-weight: 700; color: var(--accent); display: block; margin-bottom: 0.75rem;">
                            <i class="fas fa-tag"></i> Product Type *
                        </label>
                        <select id="productType" required style="font-size: 1.1rem; padding: 1rem; font-weight: 600; border: 2px solid var(--accent); background: var(--white); width: 100%;">
                            <option value="">Select Product Type</option>
                            <option value="Blouses">Blouses</option>
                            <option value="Bras">Bras</option>
                            <option value="Cargo Shorts">Cargo Shorts</option>
                            <option value="Chinos">Chinos</option>
                            <option value="Dresses">Dresses</option>
                            <option value="Formal Shirts">Formal Shirts</option>
                            <option value="Formal Shoes">Formal Shoes</option>
                            <option value="Formal Trousers">Formal Trousers</option>
                            <option value="Gym Tights">Gym Tights</option>
                            <option value="Hoodies">Hoodies</option>
                            <option value="Jackets">Jackets</option>
                            <option value="Jean Jackets">Jean Jackets</option>
                            <option value="Jeans">Jeans</option>
                            <option value="Jerseys">Jerseys</option>
                            <option value="Normal Jackets">Normal Jackets</option>
                            <option value="Sandals">Sandals</option>
                            <option value="Shorts">Shorts</option>
                            <option value="Skirts">Skirts</option>
                            <option value="Socks">Socks</option>
                            <option value="Sport Jerseys">Sport Jerseys</option>
                            <option value="Swimming Shorts">Swimming Shorts</option>
                            <option value="T-shirts">T-shirts</option>
                            <option value="Trackpants">Trackpants</option>
                            <option value="Tracksuits">Tracksuits</option>
                            <option value="All Tight Types">All Tight Types</option>
                            <option value="Nightwear (Gowns & Bonnets)">Nightwear (Gowns & Bonnets)</option>
                            <option value="Other">Other (Custom Type)</option>
                        </select>
                        <small style="display: block; margin-top: 0.5rem; color: var(--dark-silver); font-weight: 600;">
                            <i class="fas fa-info-circle"></i> Select an existing type to group with similar products, or type a new one below.
                        </small>
                        <input type="text" id="productTypeCustom" placeholder="Or enter a custom product type..." style="font-size: 1rem; padding: 0.75rem; margin-top: 0.5rem; border: 1px solid var(--silver); width: 100%; display: none;">
                    </div>

                    <div class="form-group">
                        <label for="productGender">Gender</label>
                        <select id="productGender">
                            <option value="unisex">Unisex</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                        <small>For clothing items (auto-set for shoes)</small>
                    </div>

                    <div class="form-group">
                        <label for="productSize">Size</label>
                        <input type="text" id="productSize" placeholder="e.g., M, L, XL or 8, 9, 10">
                        <small>Leave empty if multiple sizes available</small>
                    </div>

                    <div class="form-group">
                        <label for="productPrice">Price (R) *</label>
                        <input type="number" id="productPrice" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="productDescription">Description</label>
                        <textarea id="productDescription" rows="3" placeholder="Optional product description"></textarea>
                    </div>

                    <!-- Shoes Brand Section (only for shoes) -->
                    <div id="shoesBrandSection" class="shoes-brand-section">
                        <label><strong>Shoe Brand *</strong></label>
                        <input type="text" id="shoeBrand" placeholder="e.g., Nike, Adidas, Puma">
                        <small>For shoes: specify the brand name</small>
                        
                        <div class="stock-management" style="margin-top: 1rem;">
                            <div>
                                <label>Size</label>
                                <input type="text" id="shoeSize" placeholder="e.g., 8">
                            </div>
                            <div>
                                <label>Stock Quantity</label>
                                <input type="number" id="shoeStockQty" min="0" value="1">
                            </div>
                            <div style="display: flex; align-items: end;">
                                <button type="button" class="btn btn-primary" onclick="addShoeSize()">
                                    <i class="fas fa-plus"></i> Add Size
                                </button>
                            </div>
                        </div>
                        
                        <div id="shoeSizesList" class="stock-list"></div>
                    </div>

                    <!-- Regular Stock Management -->
                    <div id="regularStockSection">
                        <div class="form-group">
                            <label for="stockQuantity">Stock Quantity *</label>
                            <input type="number" id="stockQuantity" min="0" value="1" required>
                        </div>

                        <div class="form-group">
                            <label for="stockNumber">Stock/Item Number</label>
                            <input type="text" id="stockNumber" placeholder="Optional: SKU or item number">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                        <i class="fas fa-plus-circle"></i> Add Product
                    </button>
                    
                    <!-- Upload Progress Container -->
                    <div id="regularUploadProgress" class="upload-progress-container">
                        <div class="upload-progress-header">
                            <h4><i class="fas fa-cloud-upload-alt"></i> Uploading Image</h4>
                        </div>
                        <div class="upload-progress-percentage" id="regularUploadPercentage">0%</div>
                        <div class="upload-progress-bar-wrapper">
                            <div class="upload-progress-bar" id="regularUploadBar" style="width: 0%;"></div>
                        </div>
                        <div class="upload-progress-status uploading" id="regularUploadStatus">
                            <i class="fas fa-spinner fa-spin"></i> Preparing image for upload...
                        </div>
                    </div>
                </form>
            </div>

            <!-- Add Sneakers Form -->
            <div class="form-section" id="sneakersProductForm" style="display: none;">
                <h2 class="section-title">Add Sneakers</h2>
                <form id="sneakersForm">
                    <div class="form-group">
                        <label for="sneakerImage">Sneaker Image *</label>
                        <input type="file" id="sneakerImage" accept="image/*" required>
                        <small>Upload a photo of the sneakers</small>
                        <div class="image-preview-container">
                        <img id="sneakerImagePreview" class="image-preview" alt="Preview">
                            <button type="button" class="image-preview-remove" onclick="removeImagePreview('sneakerImagePreview', 'sneakerImage')" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group" style="background: var(--cream); padding: 1.5rem; border-radius: var(--radius); border: 2px solid var(--accent);">
                        <label for="sneakerCategory" style="font-size: 1.1rem; font-weight: 700; color: var(--accent); display: block; margin-bottom: 0.75rem;">
                            <i class="fas fa-tags"></i> Select Category *
                        </label>
                        <select id="sneakerCategory" required style="font-size: 1.1rem; padding: 1rem; font-weight: 600; border: 2px solid var(--accent); background: var(--white);">
                            <option value="">‚ö†Ô∏è Please Select a Category</option>
                            <option value="men">üëï Men's Sneakers</option>
                            <option value="women">üëö Women's Sneakers</option>
                        </select>
                        <small style="display: block; margin-top: 0.5rem; color: var(--dark-silver); font-weight: 600;">
                            <i class="fas fa-info-circle"></i> This determines which section the sneakers appear in on the store page
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="sneakerBrand">Brand *</label>
                        <input type="text" id="sneakerBrand" placeholder="e.g., Nike, Adidas, Puma" required>
                    </div>

                    <div class="form-group">
                        <label for="sneakerType">Sneaker Type/Name *</label>
                        <input type="text" id="sneakerType" placeholder="e.g., Air Max, Ultraboost" required>
                    </div>

                    <div class="form-group">
                        <label for="sneakerPrice">Price (R) *</label>
                        <input type="number" id="sneakerPrice" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="sneakerDescription">Description</label>
                        <textarea id="sneakerDescription" rows="3" placeholder="Optional description"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Shoe Sizes with Stock *</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="sneakerSizeInput" placeholder="Size (e.g., 8)">
                            <input type="number" id="sneakerSizeStock" placeholder="Stock" min="0" value="1">
                            <button type="button" class="btn btn-primary" onclick="addSneakerSize()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="sneakerSizesList" class="stock-list"></div>
                        <small>Add each size with stock quantity (default: 1)</small>
                    </div>

                    <div class="form-group">
                        <label for="sneakerStockNumber">Stock/Item Number</label>
                        <input type="text" id="sneakerStockNumber" placeholder="Optional: SKU or item number">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                        <i class="fas fa-plus-circle"></i> Add Sneakers
                    </button>
                    
                    <!-- Upload Progress Container -->
                    <div id="sneakersUploadProgress" class="upload-progress-container">
                        <div class="upload-progress-header">
                            <h4><i class="fas fa-cloud-upload-alt"></i> Uploading Image</h4>
                        </div>
                        <div class="upload-progress-percentage" id="sneakersUploadPercentage">0%</div>
                        <div class="upload-progress-bar-wrapper">
                            <div class="upload-progress-bar" id="sneakersUploadBar" style="width: 0%;"></div>
                        </div>
                        <div class="upload-progress-status uploading" id="sneakersUploadStatus">
                            <i class="fas fa-spinner fa-spin"></i> Preparing image for upload...
                        </div>
                    </div>
                </form>
            </div>

            <!-- Add Kids Packs Form -->
            <div class="form-section" id="kidspacksProductForm" style="display: none;">
                <h2 class="section-title">Add Kids Clothing Pack</h2>
                <form id="kidspacksForm">
                    <div class="form-group">
                        <label for="packImage">Pack Image *</label>
                        <input type="file" id="packImage" accept="image/*" required>
                        <small>Upload a photo of the clothing pack</small>
                        <div class="image-preview-container">
                        <img id="packImagePreview" class="image-preview" alt="Preview">
                            <button type="button" class="image-preview-remove" onclick="removeImagePreview('packImagePreview', 'packImage')" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="packType">Pack Type/Name *</label>
                        <input type="text" id="packType" placeholder="e.g., Kids Clothing Pack, Summer Pack" required>
                    </div>

                    <div class="form-group" style="background: var(--cream); padding: 1.5rem; border-radius: var(--radius); border: 2px solid var(--accent);">
                        <label for="packGender" style="font-size: 1.1rem; font-weight: 700; color: var(--accent); display: block; margin-bottom: 0.75rem;">
                            <i class="fas fa-venus-mars"></i> Gender *
                        </label>
                        <select id="packGender" required style="font-size: 1.1rem; padding: 1rem; font-weight: 600; border: 2px solid var(--accent); background: var(--white); width: 100%;">
                            <option value="unisex" selected>üë∂ Unisex (For All Kids)</option>
                            <option value="male">üë¶ Boys</option>
                            <option value="female">üëß Girls</option>
                        </select>
                        <small style="display: block; margin-top: 0.5rem; color: var(--dark-silver); font-weight: 600;">
                            <i class="fas fa-info-circle"></i> Select the gender this pack is designed for
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="packPrice">Price (R) *</label>
                        <input type="number" id="packPrice" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="packDescription">Description *</label>
                        <textarea id="packDescription" rows="3" placeholder="e.g., Complete outfits for children aged 0-14 years. Each pack contains 5-7 items." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="packSize">Size Range</label>
                        <input type="text" id="packSize" placeholder="e.g., 0-2 years, 3-5 years, etc.">
                        <small>Optional: Size range for this pack</small>
                    </div>

                    <div class="form-group">
                        <label for="packStockQuantity">Stock Quantity *</label>
                        <input type="number" id="packStockQuantity" min="0" value="1" required>
                        <small>Default: 1</small>
                    </div>

                    <div class="form-group">
                        <label for="packStockNumber">Stock/Item Number</label>
                        <input type="text" id="packStockNumber" placeholder="Optional: SKU or item number">
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                        <i class="fas fa-plus-circle"></i> Add Kids Pack
                    </button>
                    
                    <!-- Upload Progress Container -->
                    <div id="packsUploadProgress" class="upload-progress-container">
                        <div class="upload-progress-header">
                            <h4><i class="fas fa-cloud-upload-alt"></i> Uploading Image</h4>
                        </div>
                        <div class="upload-progress-percentage" id="packsUploadPercentage">0%</div>
                        <div class="upload-progress-bar-wrapper">
                            <div class="upload-progress-bar" id="packsUploadBar" style="width: 0%;"></div>
                        </div>
                        <div class="upload-progress-status uploading" id="packsUploadStatus">
                            <i class="fas fa-spinner fa-spin"></i> Preparing image for upload...
                        </div>
                    </div>
                </form>
            </div>

            <!-- Recently Added Page -->
            <div class="form-section" id="recentlyAddedPage" style="display: none;">
                <h2 class="section-title">
                    <i class="fas fa-clock"></i> Recently Added Products
                </h2>
                <div id="recentlyAddedList" class="products-list">
                    <!-- Recently added products will appear here -->
                </div>
            </div>

            <!-- Products List -->
            <div class="products-section">
                <h2 class="section-title">Manage Products</h2>
                
                <!-- Filter Section -->
                <div class="filter-section" style="margin-bottom: 1.5rem; background: var(--white); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow);">
                    <h3 style="color: var(--accent); margin-bottom: 1rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-filter"></i> Filter Products
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filterCategory" style="font-size: 0.9rem; font-weight: 600;">Category</label>
                            <select id="filterCategory" style="padding: 0.5rem;">
                                <option value="all">All Categories</option>
                                <option value="men">Men's Collection</option>
                                <option value="women">Women's Collection</option>
                                <option value="kids">Kids Collection</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filterType" style="font-size: 0.9rem; font-weight: 600;">Search</label>
                            <div style="display: flex; gap: 0.5rem; width: 100%;">
                                <input type="text" id="filterType" placeholder="Search products..." class="search-input" style="flex: 1; min-width: 0;">
                                <button type="button" class="btn btn-primary search-btn" onclick="applyFilters()" style="padding: 0.5rem 1rem; flex-shrink: 0;">
                                    <i class="fas fa-search"></i> <span class="search-btn-text">Search</span>
                                </button>
                            </div>
                            <small style="display: block; margin-top: 0.25rem; color: #666;">Search by product name, brand, description, or stock number</small>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filterStock" style="font-size: 0.9rem; font-weight: 600;">Stock Status</label>
                            <select id="filterStock" style="padding: 0.5rem;">
                                <option value="all">All Stock Levels</option>
                                <option value="in-stock">In Stock (10+)</option>
                                <option value="low-stock">Low Stock (1-10)</option>
                                <option value="out-of-stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="filterRecentlyAdded" style="font-size: 0.9rem; font-weight: 600;">Filter</label>
                            <select id="filterRecentlyAdded" style="padding: 0.5rem;">
                                <option value="all">All Products</option>
                                <option value="recently-added">Recently Added</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: end;">
                            <button type="button" class="btn btn-secondary" onclick="clearFilters()" style="width: 100%;">
                                <i class="fas fa-times"></i> Clear All
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--silver); flex-wrap: wrap; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <div id="productCount" class="product-count-display"></div>
                            <div id="stockCount" class="stock-count-display"></div>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--cream); border-radius: 5px;">
                                <input type="checkbox" id="showOnlyDefault" onchange="applyFilters()">
                                <span style="font-size: 0.9rem;">Default Only</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--cream); border-radius: 5px;">
                                <input type="checkbox" id="showOnlyAdmin" onchange="applyFilters()">
                                <span style="font-size: 0.9rem;">Admin Only</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="productsList" class="products-list">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Product</h3>
                <button class="close-modal" onclick="closeEditModal()">&times;</button>
            </div>
            <div id="editFormContainer">
                <!-- Edit form will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Upload Loading Overlay -->
    <div id="uploadLoadingOverlay" class="upload-loading-overlay">
        <div class="upload-loading-content">
            <div class="upload-loading-spinner"></div>
            <h3>Uploading Image</h3>
            <p id="uploadLoadingText">Saving to Assets folder...</p>
            <div class="upload-loading-percentage" id="uploadLoadingPercentage">0%</div>
        </div>
    </div>

    <script src="js/uploadHandler.js"></script>
    <script src="js/productManager.js"></script>
    <script>
        // Initialize upload handler
        const uploadHandler = new UploadHandler();
    </script>
    <script>
        // Initialize ProductManager
        const productManager = new ProductManager();
        
        // Wait for default products to load
        let productsLoaded = false;
        
        async function initializeAdmin() {
            await productManager.loadDefaultProducts();
            productsLoaded = true;
            loadProducts();
        }
        
        initializeAdmin();

        let currentShoeSizes = [];
        let currentSneakerSizes = [];

        // Tab switching
        function switchTab(tab) {
            // Hide all forms and pages
            document.getElementById('regularProductForm').style.display = 'none';
            document.getElementById('sneakersProductForm').style.display = 'none';
            document.getElementById('kidspacksProductForm').style.display = 'none';
            document.getElementById('recentlyAddedPage').style.display = 'none';

            // Reset all tab buttons
            document.getElementById('tabRegular').className = 'btn btn-secondary';
            document.getElementById('tabSneakers').className = 'btn btn-secondary';
            document.getElementById('tabKidsPacks').className = 'btn btn-secondary';
            document.getElementById('tabRecentlyAdded').className = 'btn btn-secondary';

            // Show selected form/page and activate tab
            if (tab === 'regular') {
                document.getElementById('regularProductForm').style.display = 'block';
                document.getElementById('tabRegular').className = 'btn btn-primary';
            } else if (tab === 'sneakers') {
                document.getElementById('sneakersProductForm').style.display = 'block';
                document.getElementById('tabSneakers').className = 'btn btn-primary';
            } else if (tab === 'kidspacks') {
                document.getElementById('kidspacksProductForm').style.display = 'block';
                document.getElementById('tabKidsPacks').className = 'btn btn-primary';
            } else if (tab === 'recently-added') {
                document.getElementById('recentlyAddedPage').style.display = 'block';
                document.getElementById('tabRecentlyAdded').className = 'btn btn-primary';
                // Make it full width by changing grid layout
                const adminGrid = document.querySelector('.admin-grid');
                if (adminGrid) {
                    adminGrid.style.gridTemplateColumns = '1fr';
                }
                // Load recently added products when tab is opened
                displayRecentlyAdded();
            } else {
                // Reset grid layout for other tabs
                const adminGrid = document.querySelector('.admin-grid');
                if (adminGrid) {
                    adminGrid.style.gridTemplateColumns = '1fr 2fr';
                }
            }
        }

        // Sneaker image preview
        document.getElementById('sneakerImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('sneakerImagePreview');
                    preview.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Pack image preview
        document.getElementById('packImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('packImagePreview');
                    preview.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Add sneaker size
        function addSneakerSize() {
            const size = document.getElementById('sneakerSizeInput').value;
            const qty = parseInt(document.getElementById('sneakerSizeStock').value) || 1;

            if (!size) {
                showAlert('Please enter a size', 'error');
                return;
            }

            const brand = document.getElementById('sneakerBrand').value;
            if (!brand) {
                showAlert('Please enter brand first', 'error');
                return;
            }

            const sizeObj = { size, qty, brand };
            currentSneakerSizes.push(sizeObj);
            
            document.getElementById('sneakerSizeInput').value = '';
            document.getElementById('sneakerSizeStock').value = '1';
            
            updateSneakerSizesList();
        }

        function updateSneakerSizesList() {
            const list = document.getElementById('sneakerSizesList');
            list.innerHTML = '';
            
            currentSneakerSizes.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'brand-stock-item';
                div.innerHTML = `
                    <span><strong>${item.brand}</strong> - Size ${item.size} (Qty: ${item.qty})</span>
                    <button type="button" class="btn btn-danger" onclick="removeSneakerSize(${index})" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function removeSneakerSize(index) {
            currentSneakerSizes.splice(index, 1);
            updateSneakerSizesList();
        }

        // Handle sneakers form submission
        document.getElementById('sneakersForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const imageInput = document.getElementById('sneakerImage');
            const file = imageInput.files[0];
            
            if (!file) {
                showAlert('Please select an image', 'error');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                showAlert('Invalid file type. Only JPG, JPEG, PNG, and WEBP images are allowed.', 'error');
                return;
            }

            if (currentSneakerSizes.length === 0) {
                showAlert('Please add at least one shoe size', 'error');
                return;
            }

            // Show loading spinner and disable button
            const submitBtn = document.querySelector('#sneakersForm button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            // Show upload progress container
            const progressContainer = document.getElementById('sneakersUploadProgress');
            const progressBar = document.getElementById('sneakersUploadBar');
            const progressPercentage = document.getElementById('sneakersUploadPercentage');
            const progressStatus = document.getElementById('sneakersUploadStatus');
            
            progressContainer.classList.add('active');
            progressStatus.className = 'upload-progress-status uploading';
            progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading image...';
            progressBar.style.width = '30%';
            progressPercentage.textContent = '30%';

            try {
                // Use upload handler with progress callback
                const result = await uploadHandler.upload(file, (progress, message) => {
                    progressBar.style.width = progress + '%';
                    progressPercentage.textContent = progress + '%';
                    if (message) {
                        progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + message;
                    }
                });

                // Upload successful
                progressBar.style.width = '100%';
                progressPercentage.textContent = '100%';
                progressStatus.className = 'upload-progress-status complete';
                progressStatus.innerHTML = '<i class="fas fa-check-circle"></i> Image uploaded successfully!';

                // Get the file path from response (already handles base64 if needed)
                const imagePath = result.path; // Either server path or full data URL
                
                // Get and validate category FIRST
                const selectedCategory = document.getElementById('sneakerCategory').value.trim().toLowerCase();
                
                if (!selectedCategory || selectedCategory === '') {
                    showAlert('Please select a category (Men\'s or Women\'s) before adding the sneakers', 'error');
                    document.getElementById('sneakerCategory').focus();
                    document.getElementById('sneakerCategory').style.borderColor = '#ff4444';
                    setTimeout(() => {
                        document.getElementById('sneakerCategory').style.borderColor = '';
                    }, 3000);
                    // Reset UI
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }
                
                if (!['men', 'women'].includes(selectedCategory)) {
                    showAlert('Invalid category selected. Please choose Men\'s or Women\'s', 'error');
                    // Reset UI
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }

                const productData = {
                    id: Date.now().toString(),
                    image: imagePath, // Use server path instead of base64
                    category: selectedCategory, // Use normalized lowercase category
                    type: document.getElementById('sneakerType').value,
                    gender: selectedCategory === 'men' ? 'male' : 'female',
                    size: '',
                    price: parseFloat(document.getElementById('sneakerPrice').value),
                    description: document.getElementById('sneakerDescription').value,
                    stockNumber: document.getElementById('sneakerStockNumber').value.trim() || '',
                    isShoe: true,
                    shoeBrand: document.getElementById('sneakerBrand').value,
                    shoeSizes: [...currentSneakerSizes],
                    stockQuantity: 0,
                    dateAdded: new Date().toISOString(),
                    isDefault: false
                };

                // Log the category and type being saved
                console.log('Saving sneakers:', {
                    category: selectedCategory,
                    type: productData.type,
                    brand: productData.shoeBrand,
                    id: productData.id,
                    imagePath: imagePath
                });

                await productManager.saveProduct(productData);
                
                // Trigger storage event for cross-tab sync
                window.dispatchEvent(new Event('storage'));
                // Also trigger custom event
                window.dispatchEvent(new CustomEvent('productsUpdated'));

                const categoryName = selectedCategory === 'men' ? "Men's" : "Women's";
                
                // Hide progress and reset form
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    // Reset progress bar
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressPercentage.textContent = '0%';
                    }, 300);
                    
                showAlert(`Sneakers added successfully to ${categoryName} Collection!`, 'success');
                loadProducts();
                resetSneakersForm();
                }, 1500);

            } catch (error) {
                // Handle upload error
                console.error('Upload error:', error);
                progressContainer.classList.remove('active');
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                progressStatus.className = 'upload-progress-status';
                progressStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Upload failed';
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showAlert(`Error uploading image: ${error.message || 'Please try again.'}`, 'error');
            }
        });

        function resetSneakersForm() {
            document.getElementById('sneakersForm').reset();
            removeImagePreview('sneakerImagePreview', 'sneakerImage');
            currentSneakerSizes = [];
            document.getElementById('sneakerSizesList').innerHTML = '';
            // Hide upload progress
            const progressContainer = document.getElementById('sneakersUploadProgress');
            if (progressContainer) {
                progressContainer.classList.remove('active');
            }
            // Ensure default stock is 1
            document.getElementById('sneakerSizeStock').value = '1';
        }

        // Handle kids packs form submission
        document.getElementById('kidspacksForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const imageInput = document.getElementById('packImage');
            const file = imageInput.files[0];
            
            if (!file) {
                showAlert('Please select an image', 'error');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                showAlert('Invalid file type. Only JPG, JPEG, PNG, and WEBP images are allowed.', 'error');
                return;
            }

            // Show loading spinner and disable button
            const submitBtn = document.querySelector('#kidspacksForm button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            // Show upload progress container
            const progressContainer = document.getElementById('packsUploadProgress');
            const progressBar = document.getElementById('packsUploadBar');
            const progressPercentage = document.getElementById('packsUploadPercentage');
            const progressStatus = document.getElementById('packsUploadStatus');
            
            progressContainer.classList.add('active');
            progressStatus.className = 'upload-progress-status uploading';
            progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading image...';
            progressBar.style.width = '30%';
            progressPercentage.textContent = '30%';

            try {
                // Use upload handler with progress callback
                const result = await uploadHandler.upload(file, (progress, message) => {
                    progressBar.style.width = progress + '%';
                    progressPercentage.textContent = progress + '%';
                    if (message) {
                        progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + message;
                    }
                });

                // Upload successful
                progressBar.style.width = '100%';
                progressPercentage.textContent = '100%';
                progressStatus.className = 'upload-progress-status complete';
                progressStatus.innerHTML = '<i class="fas fa-check-circle"></i> Image uploaded successfully!';

                // Get the file path from response (already handles base64 if needed)
                const imagePath = result.path; // Either server path or full data URL
                
                // Get selected gender
                const selectedGender = document.getElementById('packGender').value || 'unisex';
                
                const productData = {
                    id: Date.now().toString(),
                    image: imagePath, // Use server path instead of base64
                    category: 'kids',
                    type: document.getElementById('packType').value,
                    gender: selectedGender,
                    size: document.getElementById('packSize').value,
                    price: parseFloat(document.getElementById('packPrice').value),
                    description: document.getElementById('packDescription').value,
                    stockNumber: document.getElementById('packStockNumber').value.trim() || '',
                    isShoe: false,
                    stockQuantity: parseInt(document.getElementById('packStockQuantity').value) || 1,
                    dateAdded: new Date().toISOString(),
                    isDefault: false
                };

                // Log the category and type being saved
                console.log('Saving kids pack:', {
                    category: 'kids',
                    type: productData.type,
                    gender: productData.gender,
                    imagePath: imagePath,
                    id: productData.id
                });

                await productManager.saveProduct(productData);
                
                // Trigger storage event for cross-tab sync
                window.dispatchEvent(new Event('storage'));
                // Also trigger custom event
                window.dispatchEvent(new CustomEvent('productsUpdated'));

                // Hide progress and reset form
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    // Reset progress bar
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressPercentage.textContent = '0%';
                    }, 300);

                showAlert('Kids pack added successfully to Kids Collection!', 'success');
                loadProducts();
                resetPacksForm();
                }, 1500);

            } catch (error) {
                // Handle upload error
                console.error('Upload error:', error);
                progressContainer.classList.remove('active');
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                progressStatus.className = 'upload-progress-status';
                progressStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Upload failed';
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showAlert(`Error uploading image: ${error.message || 'Please try again.'}`, 'error');
            }
        });

        function resetPacksForm() {
            document.getElementById('kidspacksForm').reset();
            removeImagePreview('packImagePreview', 'packImage');
            document.getElementById('packStockQuantity').value = '1';
            // Reset gender to unisex
            document.getElementById('packGender').value = 'unisex';
            // Hide upload progress
            const progressContainer = document.getElementById('packsUploadProgress');
            if (progressContainer) {
                progressContainer.classList.remove('active');
            }
        }

        // Handle product type dropdown and custom input
        const productTypeSelect = document.getElementById('productType');
        const productTypeCustom = document.getElementById('productTypeCustom');
        
        // Show custom input when "Other" or empty is selected, or allow custom entry
        productTypeSelect.addEventListener('change', function() {
            if (this.value === '' || this.value === 'Other') {
                productTypeCustom.style.display = 'block';
                productTypeCustom.required = true;
            } else {
                productTypeCustom.style.display = 'none';
                productTypeCustom.required = false;
            }
            
            // Check product type to show/hide shoe brand section
            const productType = this.value.toLowerCase();
            const shoesBrandSection = document.getElementById('shoesBrandSection');
            const regularStockSection = document.getElementById('regularStockSection');
            
            if (productType.includes('shoe') || productType.includes('sneaker') || 
                productType.includes('sandal') || productType.includes('takkies')) {
                shoesBrandSection.classList.add('show');
                regularStockSection.style.display = 'none';
                currentShoeSizes = [];
            } else {
                shoesBrandSection.classList.remove('show');
                regularStockSection.style.display = 'block';
            }
        });
        
        // Also check custom input
        if (productTypeCustom) {
            productTypeCustom.addEventListener('input', function() {
                const productType = this.value.toLowerCase();
                const shoesBrandSection = document.getElementById('shoesBrandSection');
                const regularStockSection = document.getElementById('regularStockSection');
                
                if (productType.includes('shoe') || productType.includes('sneaker') || 
                    productType.includes('sandal') || productType.includes('takkies')) {
                    shoesBrandSection.classList.add('show');
                    regularStockSection.style.display = 'none';
                    currentShoeSizes = [];
                } else {
                    shoesBrandSection.classList.remove('show');
                    regularStockSection.style.display = 'block';
                }
            });
        }

        // Function to remove image preview
        function removeImagePreview(previewId, inputId) {
            const preview = document.getElementById(previewId);
            const input = document.getElementById(inputId);
            if (preview) {
                preview.src = '';
                preview.classList.remove('show');
            }
            if (input) {
                input.value = '';
            }
        }

        // Image preview
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        });

        // Add shoe size
        function addShoeSize() {
            const size = document.getElementById('shoeSize').value;
            const qty = parseInt(document.getElementById('shoeStockQty').value) || 0;
            const brand = document.getElementById('shoeBrand').value;

            if (!size || !brand) {
                showAlert('Please enter both brand and size', 'error');
                return;
            }

            const sizeObj = { size, qty, brand };
            currentShoeSizes.push(sizeObj);
            
            document.getElementById('shoeSize').value = '';
            document.getElementById('shoeStockQty').value = '1';
            
            updateShoeSizesList();
        }

        function updateShoeSizesList() {
            const list = document.getElementById('shoeSizesList');
            list.innerHTML = '';
            
            currentShoeSizes.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'brand-stock-item';
                div.innerHTML = `
                    <span><strong>${item.brand}</strong> - Size ${item.size} (Qty: ${item.qty})</span>
                    <button type="button" class="btn btn-danger" onclick="removeShoeSize(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function removeShoeSize(index) {
            currentShoeSizes.splice(index, 1);
            updateShoeSizesList();
        }

        // Handle form submission
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const imageInput = document.getElementById('productImage');
            const file = imageInput.files[0];
            
            if (!file) {
                showAlert('Please select an image', 'error');
                return;
            }

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                showAlert('Invalid file type. Only JPG, JPEG, PNG, and WEBP images are allowed.', 'error');
                return;
            }

            // Show loading spinner and disable button
            const submitBtn = document.querySelector('#productForm button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            // Show upload progress container
            const progressContainer = document.getElementById('regularUploadProgress');
            const progressBar = document.getElementById('regularUploadBar');
            const progressPercentage = document.getElementById('regularUploadPercentage');
            const progressStatus = document.getElementById('regularUploadStatus');
            
            progressContainer.classList.add('active');
            progressStatus.className = 'upload-progress-status uploading';
            progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading image...';
            progressBar.style.width = '30%';
            progressPercentage.textContent = '30%';

            try {
                // Use upload handler with progress callback
                const result = await uploadHandler.upload(file, (progress, message) => {
                    progressBar.style.width = progress + '%';
                    progressPercentage.textContent = progress + '%';
                    if (message) {
                        progressStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + message;
                    }
                });

                // Upload successful
                progressBar.style.width = '100%';
                progressPercentage.textContent = '100%';
                progressStatus.className = 'upload-progress-status complete';
                progressStatus.innerHTML = '<i class="fas fa-check-circle"></i> Image uploaded successfully!';

                // Get the file path from response (already handles base64 if needed)
                const imagePath = result.path; // Either server path or full data URL

                // Get and validate category FIRST
                const selectedCategory = document.getElementById('productCategory').value.trim().toLowerCase();
                
                if (!selectedCategory || selectedCategory === '') {
                    showAlert('Please select a category (Men\'s, Women\'s, or Kids) before adding the product', 'error');
                    document.getElementById('productCategory').focus();
                    document.getElementById('productCategory').style.borderColor = '#ff4444';
                    setTimeout(() => {
                        document.getElementById('productCategory').style.borderColor = '';
                    }, 3000);
                    // Reset UI
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }
                
                if (!['men', 'women', 'kids'].includes(selectedCategory)) {
                    showAlert('Invalid category selected. Please choose Men\'s, Women\'s, or Kids Collection', 'error');
                    // Reset UI
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }

                // Get and validate product type (from dropdown or custom input)
                const productTypeSelect = document.getElementById('productType');
                const productTypeCustom = document.getElementById('productTypeCustom');
                let productType = productTypeSelect.value.trim();
                
                // If custom input is visible and filled, use that instead
                if (productTypeCustom.style.display !== 'none' && productTypeCustom.value.trim()) {
                    productType = productTypeCustom.value.trim();
                }
                
                if (!productType || productType === '') {
                    showAlert('Please select or enter a product type before adding the product', 'error');
                    (productTypeCustom.style.display !== 'none' ? productTypeCustom : productTypeSelect).focus();
                    (productTypeCustom.style.display !== 'none' ? productTypeCustom : productTypeSelect).style.borderColor = '#ff4444';
                    setTimeout(() => {
                        (productTypeCustom.style.display !== 'none' ? productTypeCustom : productTypeSelect).style.borderColor = '';
                    }, 3000);
                    // Reset UI
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }

                const productData = {
                    id: Date.now().toString(),
                    image: imagePath, // Use server path instead of base64
                    category: selectedCategory, // Use normalized lowercase category
                    type: productType, // Use trimmed product type
                    gender: document.getElementById('productGender').value,
                    size: document.getElementById('productSize').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    description: document.getElementById('productDescription').value,
                    stockNumber: document.getElementById('stockNumber').value.trim() || '',
                    isShoe: document.getElementById('shoesBrandSection').classList.contains('show'),
                    shoeBrand: document.getElementById('shoeBrand').value,
                    shoeSizes: currentShoeSizes.length > 0 ? [...currentShoeSizes] : [],
                    stockQuantity: currentShoeSizes.length > 0 ? 0 : parseInt(document.getElementById('stockQuantity').value) || 0,
                    dateAdded: new Date().toISOString(),
                    isDefault: false
                };

                // Validate shoe products
                if (productData.isShoe) {
                    if (!productData.shoeBrand) {
                        showAlert('Please enter shoe brand', 'error');
                        // Reset UI
                        progressContainer.classList.remove('active');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }
                    if (currentShoeSizes.length === 0) {
                        showAlert('Please add at least one shoe size', 'error');
                        // Reset UI
                        progressContainer.classList.remove('active');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }
                }

                // Log the category and type being saved
                console.log('Saving product:', {
                    category: selectedCategory,
                    type: productData.type,
                    id: productData.id,
                    imagePath: imagePath,
                    willAppearOn: `product-type.html?type=${encodeURIComponent(productData.type)}&category=${selectedCategory}`
                });
                
                // Get product name (use name field if provided, otherwise fall back to type)
                const productName = document.getElementById('productName').value.trim() || productData.type;
                
                // Save product with proper structure
                const adminProduct = {
                    id: productData.id,
                    name: productName,
                    price: productData.price,
                    description: productData.description,
                    imageURL: imagePath, // Use server path
                    category: productData.category,
                    // Keep all original fields for compatibility
                    ...productData,
                    // Ensure name is set correctly
                    name: productName
                };
                
                productManager.saveProduct(adminProduct);
                
                // Also save to adminProducts for separate tracking
                const adminProducts = JSON.parse(localStorage.getItem('adminProducts') || '[]');
                adminProducts.push({
                    id: adminProduct.id,
                    name: adminProduct.name,
                    price: adminProduct.price,
                    description: adminProduct.description,
                    imageURL: adminProduct.imageURL,
                    category: adminProduct.category
                });
                localStorage.setItem('adminProducts', JSON.stringify(adminProducts));
                
                // Trigger storage event for cross-tab sync
                window.dispatchEvent(new Event('storage'));
                // Also trigger custom event
                window.dispatchEvent(new CustomEvent('productsUpdated'));

                // Hide progress and reset form
                setTimeout(() => {
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    // Reset progress bar
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                        progressPercentage.textContent = '0%';
                    }, 300);
                    
                    // Show success message
                    const categoryName = selectedCategory === 'men' ? "Men's" : selectedCategory === 'women' ? "Women's" : "Kids";
                    showAlert(`‚úÖ Product added successfully to ${categoryName} Collection!`, 'success');
                    
                    // Auto-refresh products list
                    loadProducts();
                    resetForm();
                }, 1500);

            } catch (error) {
                // Handle upload error
                console.error('Upload error:', error);
                progressContainer.classList.remove('active');
                progressBar.style.width = '0%';
                progressPercentage.textContent = '0%';
                progressStatus.className = 'upload-progress-status';
                progressStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Upload failed';
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showAlert(`Error uploading image: ${error.message || 'Please try again.'}`, 'error');
            }
        });

        function resetForm() {
            document.getElementById('productForm').reset();
            removeImagePreview('imagePreview', 'productImage');
            document.getElementById('shoesBrandSection').classList.remove('show');
            document.getElementById('regularStockSection').style.display = 'block';
            currentShoeSizes = [];
            document.getElementById('shoeSizesList').innerHTML = '';
            // Hide upload progress
            const progressContainer = document.getElementById('regularUploadProgress');
            if (progressContainer) {
                progressContainer.classList.remove('active');
            }
            // Reset product type dropdown and hide custom input
            document.getElementById('productType').value = '';
            const customInput = document.getElementById('productTypeCustom');
            if (customInput) {
                customInput.style.display = 'none';
                customInput.value = '';
            }
            // Reset product name field
            const productNameField = document.getElementById('productName');
            if (productNameField) {
                productNameField.value = '';
            }
        }

        let allProducts = [];
        let filteredProducts = [];

        async function loadProducts() {
            if (!productsLoaded) {
                await productManager.loadDefaultProducts();
                productsLoaded = true;
            }
            
            // Force reload products to get latest data from database
            allProducts = await productManager.getAllProducts();
            // Update recently added section
            displayRecentlyAdded();
            // Clear and reapply filters to refresh display
            applyFilters();
        }

        function applyFilters() {
            if (!allProducts || allProducts.length === 0) {
                return;
            }

            const categoryFilter = document.getElementById('filterCategory')?.value || 'all';
            const typeFilter = (document.getElementById('filterType')?.value || '').toLowerCase();
            const stockFilter = document.getElementById('filterStock')?.value || 'all';
            const recentlyAddedFilter = document.getElementById('filterRecentlyAdded')?.value || 'all';
            const showOnlyDefault = document.getElementById('showOnlyDefault')?.checked || false;
            const showOnlyAdmin = document.getElementById('showOnlyAdmin')?.checked || false;

            filteredProducts = allProducts.filter(product => {
                // Category filter
                if (categoryFilter !== 'all' && product.category !== categoryFilter) {
                    return false;
                }

                // Type filter (search by product type, brand, description, or stock number)
                if (typeFilter) {
                    const matchesType = product.type.toLowerCase().includes(typeFilter);
                    const matchesBrand = product.shoeBrand && product.shoeBrand.toLowerCase().includes(typeFilter);
                    const matchesDescription = product.description && product.description.toLowerCase().includes(typeFilter);
                    const matchesStockNumber = product.stockNumber && product.stockNumber.toLowerCase().includes(typeFilter);
                    
                    if (!matchesType && !matchesBrand && !matchesDescription && !matchesStockNumber) {
                        return false;
                    }
                }

                // Stock filter
                let stockCount = 0;
                if (product.isShoe && product.shoeSizes && product.shoeSizes.length > 0) {
                    stockCount = product.shoeSizes.reduce((sum, size) => sum + (size.qty || 0), 0);
                } else {
                    stockCount = product.stockQuantity || 0;
                }

                if (stockFilter === 'in-stock' && stockCount <= 10) return false;
                if (stockFilter === 'low-stock' && (stockCount === 0 || stockCount > 10)) return false;
                if (stockFilter === 'out-of-stock' && stockCount > 0) return false;

                // Recently Added filter
                if (recentlyAddedFilter === 'recently-added') {
                    if (!product.dateAdded || product.isDefault) return false;
                    // Only show products added in last 7 days
                    const addedDate = new Date(product.dateAdded);
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                    if (addedDate < sevenDaysAgo) return false;
                }

                // Default/Admin filter
                const isDefault = product.isDefault === true;
                if (showOnlyDefault && !isDefault) return false;
                if (showOnlyAdmin && isDefault) return false;

                return true;
            });

            displayProducts(filteredProducts);
            displayRecentlyAdded(); // Update recently added section
            updateProductCount();
        }

        function clearFilters() {
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('filterType').value = '';
            document.getElementById('filterStock').value = 'all';
            document.getElementById('filterRecentlyAdded').value = 'all';
            document.getElementById('showOnlyDefault').checked = false;
            document.getElementById('showOnlyAdmin').checked = false;
            applyFilters();
        }

        function updateProductCount() {
            const countElement = document.getElementById('productCount');
            const stockCountElement = document.getElementById('stockCount');
            
            if (countElement) {
                const total = allProducts.length;
                const showing = filteredProducts.length;
                if (showing === total) {
                    countElement.innerHTML = `<span>Showing <strong>${showing}</strong> of <strong>${total}</strong> products</span>`;
                } else {
                    countElement.innerHTML = `<span>Showing <strong>${showing}</strong> of <strong>${total}</strong> products <span style="color: #666; font-size: 0.9em;">(filtered)</span></span>`;
                }
            }
            
            // Calculate total stock count
            if (stockCountElement) {
                let totalStock = 0;
                
                filteredProducts.forEach(product => {
                    if (product.isShoe && product.shoeSizes && product.shoeSizes.length > 0) {
                        // Sum all shoe sizes
                        product.shoeSizes.forEach(size => {
                            totalStock += size.qty || 0;
                        });
                    } else {
                        // Regular product stock
                        totalStock += product.stockQuantity || 0;
                    }
                });
                
                stockCountElement.innerHTML = `<span>Total Stock: <strong>${totalStock}</strong> items</span>`;
            }
        }

        function displayRecentlyAdded() {
            const recentlyAddedPage = document.getElementById('recentlyAddedPage');
            const recentlyAddedList = document.getElementById('recentlyAddedList');
            
            if (!recentlyAddedPage || !recentlyAddedList) return;

            // Get all admin-added products (non-default) sorted by date
            const adminProducts = allProducts
                .filter(p => !p.isDefault && p.dateAdded)
                .sort((a, b) => {
                    const dateA = new Date(a.dateAdded);
                    const dateB = new Date(b.dateAdded);
                    return dateB - dateA; // Most recent first
                }); // Show all recently added products

            // Show message if no recently added products
            if (adminProducts.length === 0) {
                recentlyAddedList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem; font-size: 1.1rem;">No recently added products yet. Add products to see them here!</p>';
                return;
            }

            // Display recently added products
            recentlyAddedList.innerHTML = adminProducts.map((product, index) => {
                const productId = product.id;
                const isDefault = false; // All are admin-added
                
                // Calculate actual stock quantity
                let actualStock = 0;
                if (product.isShoe && product.shoeSizes && product.shoeSizes.length > 0) {
                    // Sum all shoe sizes for total stock
                    actualStock = product.shoeSizes.reduce((sum, size) => sum + (size.qty || 0), 0);
                } else {
                    // Regular product stock
                    actualStock = product.stockQuantity || 0;
                }

                // Format date
                const addedDate = new Date(product.dateAdded);
                const dateStr = addedDate.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="product-item" data-product-id="${productId}">
                        <div class="product-item-number">${index + 1}</div>
                        <div class="product-item-header">
                            <img src="${product.image}" alt="${product.type}" class="product-item-image">
                            <div class="product-item-info">
                                <h3>${product.type} <span style="color: #666; font-size: 0.8rem;">(Added: ${dateStr})</span></h3>
                                <p><strong>Category:</strong> ${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</p>
                                <p><strong>Gender:</strong> ${product.gender}</p>
                                ${product.size ? `<p><strong>Size:</strong> ${product.size}</p>` : ''}
                                ${product.isShoe && product.shoeBrand ? `<p><strong>Brand:</strong> ${product.shoeBrand}</p>` : ''}
                                <p><strong>Price:</strong> ${product.priceRange || (product.price ? 'R' + product.price.toFixed(2) : 'Price on request')}</p>
                                <p><strong>Stock:</strong> <span class="stock-quantity-display">${actualStock}</span></p>
                                ${product.stockNumber ? `<p><strong>Stock #:</strong> ${product.stockNumber}</p>` : ''}
                            </div>
                            <div class="product-item-actions">
                                <button class="btn-edit" onclick="editProduct('${productId}', ${isDefault})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-delete" onclick="deleteProduct('${productId}', ${isDefault}, event)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        ${product.isShoe && product.shoeSizes && product.shoeSizes.length > 0 ? `
                            <div class="stock-management">
                                ${product.shoeSizes.map((shoe, idx) => `
                                    <div class="stock-entry shoe-size-item">
                                        <span><strong>${shoe.brand}</strong> - Size ${shoe.size}: <span class="shoe-stock-quantity">${shoe.qty}</span> available</span>
                                        <div class="stock-controls">
                                            <button type="button" class="btn-increment" onclick="updateShoeStock('${productId}', ${idx}, 1, ${isDefault}, event)">+</button>
                                            <button type="button" class="btn-decrement" onclick="updateShoeStock('${productId}', ${idx}, -1, ${isDefault}, event)">-</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="stock-management">
                                <div class="stock-item" style="justify-content: flex-end;">
                                    <div class="stock-controls">
                                        <button type="button" class="btn-increment" onclick="updateStock('${productId}', 1, ${isDefault}, event)">+</button>
                                        <button type="button" class="btn-decrement" onclick="updateStock('${productId}', -1, ${isDefault}, event)">-</button>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        function displayProducts(products) {
            const productsList = document.getElementById('productsList');
            
            if (products.length === 0) {
                productsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No products match your filters.</p>';
                return;
            }

            productsList.innerHTML = products.map((product, index) => {
                // Check if product is default - use the isDefault property from getAllProducts
                const isDefault = product.isDefault === true;
                const productId = product.id;
                // Calculate actual stock quantity
                let actualStock = 0;
                if (product.isShoe && product.shoeSizes && product.shoeSizes.length > 0) {
                    // Sum all shoe sizes for total stock
                    actualStock = product.shoeSizes.reduce((sum, size) => sum + (size.qty || 0), 0);
                } else {
                    // Regular product stock
                    actualStock = product.stockQuantity || 0;
                }

                return `
                    <div class="product-item" data-product-id="${productId}">
                        <div class="product-item-number">${index + 1}</div>
                        <div class="product-item-header">
                            <img src="${product.image}" alt="${product.type}" class="product-item-image">
                            <div class="product-item-info">
                                <h3>${product.type} ${isDefault ? '<span style="color: #666; font-size: 0.8rem;">(Default)</span>' : ''}</h3>
                                <p><strong>Category:</strong> ${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</p>
                                <p><strong>Gender:</strong> ${product.gender}</p>
                                ${product.size ? `<p><strong>Size:</strong> ${product.size}</p>` : ''}
                                ${product.isShoe && product.shoeBrand ? `<p><strong>Brand:</strong> ${product.shoeBrand}</p>` : ''}
                                <p><strong>Price:</strong> ${product.priceRange || (product.price ? 'R' + product.price.toFixed(2) : 'Price on request')}</p>
                                <p><strong>Stock:</strong> <span class="stock-quantity-display">${actualStock}</span></p>
                                ${product.stockNumber ? `<p><strong>Stock #:</strong> ${product.stockNumber}</p>` : ''}
                            </div>
                            <div class="product-item-actions">
                                <button class="btn-edit" onclick="editProduct('${productId}', ${isDefault})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn-delete" onclick="deleteProduct('${productId}', ${isDefault}, event)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        ${product.isShoe && product.shoeSizes && product.shoeSizes.length > 0 ? `
                            <div class="stock-management">
                                ${product.shoeSizes.map((shoe, idx) => `
                                    <div class="stock-entry shoe-size-item">
                                        <span><strong>${shoe.brand}</strong> - Size ${shoe.size}: <span class="shoe-stock-quantity">${shoe.qty}</span> available</span>
                                        <div class="stock-controls">
                                            <button type="button" class="btn-increment" onclick="updateShoeStock('${productId}', ${idx}, 1, ${isDefault}, event)">+</button>
                                            <button type="button" class="btn-decrement" onclick="updateShoeStock('${productId}', ${idx}, -1, ${isDefault}, event)">-</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="stock-management">
                                <div class="stock-item" style="justify-content: flex-end;">
                                    <div class="stock-controls">
                                        <button type="button" class="btn-increment" onclick="updateStock('${productId}', 1, ${isDefault}, event)">+</button>
                                        <button type="button" class="btn-decrement" onclick="updateStock('${productId}', -1, ${isDefault}, event)">-</button>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function updateStock(productId, change, isDefault, eventObj) {
            // Prevent multiple clicks and default behavior
            const evt = eventObj || window.event;
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }
            
            // Find the product item and stock span
            const productItem = document.querySelector(`[data-product-id="${productId}"]`);
            if (!productItem) return;
            
            const stockSpan = productItem.querySelector('.stock-quantity-display');
            if (!stockSpan) return;
            
            // Find and disable the clicked button temporarily
            const button = evt ? evt.target.closest('button') : null;
            if (button) {
                button.disabled = true;
            }
            
            // Get current stock value from display
            let currentStock = parseInt(stockSpan.textContent) || 0;
            const newStock = Math.max(0, currentStock + change);
            
            // Update display immediately (optimistic update)
            stockSpan.textContent = newStock;
            stockSpan.style.transition = 'none';
            stockSpan.style.color = '#25A525';
            setTimeout(() => {
                stockSpan.style.color = '';
                stockSpan.style.transition = '';
            }, 500);
            
            try {
            if (isDefault) {
                // For default products, get the product and update it
                const product = await productManager.getProductById(productId);
                if (product) {
                    const updatedData = {
                            stockQuantity: newStock
                    };
                    await productManager.updateProduct(productId, updatedData);
                        // Update the product in allProducts array
                        const index = allProducts.findIndex(p => p.id === productId);
                        if (index !== -1) {
                            allProducts[index].stockQuantity = newStock;
                        }
                }
            } else {
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const product = products.find(p => p.id === productId || p.originalId === productId);
                
                if (product) {
                        product.stockQuantity = newStock;
                    localStorage.setItem('products', JSON.stringify(products));
                        // Update the product in allProducts array
                        const index = allProducts.findIndex(p => p.id === productId || p.originalId === productId);
                        if (index !== -1) {
                            allProducts[index].stockQuantity = newStock;
                        }
                    // Trigger events for cross-tab sync
                    window.dispatchEvent(new Event('storage'));
                    window.dispatchEvent(new CustomEvent('productsUpdated'));
                    }
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                // Revert on error
                stockSpan.textContent = currentStock;
            } finally {
                // Re-enable button after a short delay
                if (button) {
                    setTimeout(() => {
                        button.disabled = false;
                    }, 200);
                }
            }
        }

        async function updateShoeStock(productId, sizeIndex, change, isDefault, eventObj) {
            // Prevent multiple clicks and default behavior
            const evt = eventObj || window.event;
            if (evt) {
                evt.preventDefault();
                evt.stopPropagation();
            }
            
            // Find the product item and specific shoe size element
            const productItem = document.querySelector(`[data-product-id="${productId}"]`);
            if (!productItem) return;
            
            const shoeSizeItems = productItem.querySelectorAll('.shoe-size-item');
            const sizeItem = shoeSizeItems[sizeIndex];
            if (!sizeItem) return;
            
            const stockSpan = sizeItem.querySelector('.shoe-stock-quantity');
            if (!stockSpan) return;
            
            // Find and disable the clicked button temporarily
            const button = evt ? evt.target.closest('button') : null;
            if (button) {
                button.disabled = true;
            }
            
            // Get current stock value from display
            const stockText = stockSpan.textContent;
            const match = stockText.match(/(\d+)/);
            let currentStock = match ? parseInt(match[1]) : 0;
            const newStock = Math.max(0, currentStock + change);
            
            // Update display immediately (optimistic update)
            const newText = stockText.replace(/\d+/, newStock);
            stockSpan.textContent = newText;
            stockSpan.style.transition = 'none';
            stockSpan.style.color = '#25A525';
            setTimeout(() => {
                stockSpan.style.color = '';
                stockSpan.style.transition = '';
            }, 500);
            
            try {
            if (isDefault) {
                const product = await productManager.getProductById(productId);
                if (product && product.shoeSizes && product.shoeSizes[sizeIndex]) {
                    const updatedSizes = [...product.shoeSizes];
                        updatedSizes[sizeIndex].qty = newStock;
                    await productManager.updateProduct(productId, { shoeSizes: updatedSizes });
                        // Update the product in allProducts array
                        const index = allProducts.findIndex(p => p.id === productId);
                        if (index !== -1 && allProducts[index].shoeSizes) {
                            allProducts[index].shoeSizes[sizeIndex].qty = newStock;
                            // Update header stock display
                            const headerStockSpan = productItem.querySelector('.stock-quantity-display');
                            if (headerStockSpan) {
                                const totalStock = allProducts[index].shoeSizes.reduce((sum, size) => sum + (size.qty || 0), 0);
                                headerStockSpan.textContent = totalStock;
                                headerStockSpan.style.transition = 'none';
                                headerStockSpan.style.color = '#25A525';
                                setTimeout(() => {
                                    headerStockSpan.style.color = '';
                                    headerStockSpan.style.transition = '';
                                }, 500);
                            }
                        }
                }
            } else {
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                const product = products.find(p => p.id === productId || p.originalId === productId);
                
                if (product && product.shoeSizes && product.shoeSizes[sizeIndex]) {
                        product.shoeSizes[sizeIndex].qty = newStock;
                    localStorage.setItem('products', JSON.stringify(products));
                        // Update the product in allProducts array
                        const index = allProducts.findIndex(p => p.id === productId || p.originalId === productId);
                        if (index !== -1 && allProducts[index].shoeSizes) {
                            allProducts[index].shoeSizes[sizeIndex].qty = newStock;
                            // Update header stock display
                            const headerStockSpan = productItem.querySelector('.stock-quantity-display');
                            if (headerStockSpan) {
                                const totalStock = allProducts[index].shoeSizes.reduce((sum, size) => sum + (size.qty || 0), 0);
                                headerStockSpan.textContent = totalStock;
                                headerStockSpan.style.transition = 'none';
                                headerStockSpan.style.color = '#25A525';
                                setTimeout(() => {
                                    headerStockSpan.style.color = '';
                                    headerStockSpan.style.transition = '';
                                }, 500);
                            }
                        }
                    // Trigger events for cross-tab sync
                    window.dispatchEvent(new Event('storage'));
                    window.dispatchEvent(new CustomEvent('productsUpdated'));
                    }
                }
            } catch (error) {
                console.error('Error updating shoe stock:', error);
                // Revert on error
                stockSpan.textContent = stockText;
            } finally {
                // Re-enable button after a short delay
                if (button) {
                    setTimeout(() => {
                        button.disabled = false;
                    }, 200);
                }
            }
        }

        function editProduct(productId, isDefault) {
            const product = isDefault 
                ? productManager.getProductById(productId)
                : JSON.parse(localStorage.getItem('products') || '[]').find(p => p.id === productId);
            
            if (!product) return;

            const editForm = `
                <form id="editProductForm">
                    <div class="form-group">
                        <label>Product Image</label>
                        <input type="file" id="editProductImage" accept="image/*">
                        <small>Leave empty to keep current image</small>
                        <div style="position: relative; display: inline-block; margin-top: 0.5rem;">
                            <img src="${product.image}" alt="Current" id="editCurrentImage" style="max-width: 200px; border-radius: 8px; display: block;">
                            ${product.image && product.image.includes('Assets/') ? `
                                <button type="button" onclick="deleteProductImage('${product.id}', '${product.image}', ${isDefault})" 
                                        style="position: absolute; top: 5px; right: 5px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);" 
                                        title="Delete this image from server">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                        <small style="display: block; margin-top: 0.5rem; color: #666;">
                            ${product.image && product.image.includes('Assets/') ? '‚ö†Ô∏è Deleting the image will remove it from the server permanently.' : ''}
                        </small>
                    </div>
                    <div class="form-group" style="background: var(--cream); padding: 1.5rem; border-radius: var(--radius); border: 2px solid var(--accent);">
                        <label for="editCategory" style="font-size: 1.1rem; font-weight: 700; color: var(--accent); display: block; margin-bottom: 0.75rem;">
                            <i class="fas fa-tags"></i> Select Product Category *
                        </label>
                        <select id="editCategory" required style="font-size: 1.1rem; padding: 1rem; font-weight: 600; border: 2px solid var(--accent); background: var(--white);">
                            <option value="">‚ö†Ô∏è Please Select a Category</option>
                            <option value="men" ${product.category === 'men' ? 'selected' : ''}>üëï Men's Collection</option>
                            <option value="women" ${product.category === 'women' ? 'selected' : ''}>üëö Women's Collection</option>
                            <option value="kids" ${product.category === 'kids' ? 'selected' : ''}>üë∂ Kids Collection</option>
                        </select>
                        <small style="display: block; margin-top: 0.5rem; color: var(--dark-silver); font-weight: 600;">
                            <i class="fas fa-info-circle"></i> This determines which section the product appears in on the store page
                        </small>
                    </div>
                    <div class="form-group" style="background: var(--cream); padding: 1.5rem; border-radius: var(--radius); border: 2px solid var(--accent);">
                        <label for="editType" style="font-size: 1.1rem; font-weight: 700; color: var(--accent); display: block; margin-bottom: 0.75rem;">
                            <i class="fas fa-tag"></i> Product Type *
                        </label>
                        <select id="editType" required style="font-size: 1.1rem; padding: 1rem; font-weight: 600; border: 2px solid var(--accent); background: var(--white); width: 100%;">
                            <option value="">Select Product Type</option>
                            <option value="Blouses" ${product.type === 'Blouses' ? 'selected' : ''}>Blouses</option>
                            <option value="Bras" ${product.type === 'Bras' ? 'selected' : ''}>Bras</option>
                            <option value="Cargo Shorts" ${product.type === 'Cargo Shorts' ? 'selected' : ''}>Cargo Shorts</option>
                            <option value="Chinos" ${product.type === 'Chinos' ? 'selected' : ''}>Chinos</option>
                            <option value="Dresses" ${product.type === 'Dresses' ? 'selected' : ''}>Dresses</option>
                            <option value="Formal Shirts" ${product.type === 'Formal Shirts' ? 'selected' : ''}>Formal Shirts</option>
                            <option value="Formal Shoes" ${product.type === 'Formal Shoes' ? 'selected' : ''}>Formal Shoes</option>
                            <option value="Formal Trousers" ${product.type === 'Formal Trousers' ? 'selected' : ''}>Formal Trousers</option>
                            <option value="Gym Tights" ${product.type === 'Gym Tights' ? 'selected' : ''}>Gym Tights</option>
                            <option value="Hoodies" ${product.type === 'Hoodies' ? 'selected' : ''}>Hoodies</option>
                            <option value="Jackets" ${product.type === 'Jackets' ? 'selected' : ''}>Jackets</option>
                            <option value="Jean Jackets" ${product.type === 'Jean Jackets' ? 'selected' : ''}>Jean Jackets</option>
                            <option value="Jeans" ${product.type === 'Jeans' ? 'selected' : ''}>Jeans</option>
                            <option value="Jerseys" ${product.type === 'Jerseys' ? 'selected' : ''}>Jerseys</option>
                            <option value="Normal Jackets" ${product.type === 'Normal Jackets' ? 'selected' : ''}>Normal Jackets</option>
                            <option value="Sandals" ${product.type === 'Sandals' ? 'selected' : ''}>Sandals</option>
                            <option value="Shorts" ${product.type === 'Shorts' ? 'selected' : ''}>Shorts</option>
                            <option value="Skirts" ${product.type === 'Skirts' ? 'selected' : ''}>Skirts</option>
                            <option value="Socks" ${product.type === 'Socks' ? 'selected' : ''}>Socks</option>
                            <option value="Sport Jerseys" ${product.type === 'Sport Jerseys' ? 'selected' : ''}>Sport Jerseys</option>
                            <option value="Swimming Shorts" ${product.type === 'Swimming Shorts' ? 'selected' : ''}>Swimming Shorts</option>
                            <option value="T-shirts" ${product.type === 'T-shirts' ? 'selected' : ''}>T-shirts</option>
                            <option value="Trackpants" ${product.type === 'Trackpants' ? 'selected' : ''}>Trackpants</option>
                            <option value="Tracksuits" ${product.type === 'Tracksuits' ? 'selected' : ''}>Tracksuits</option>
                            <option value="All Tight Types" ${product.type === 'All Tight Types' ? 'selected' : ''}>All Tight Types</option>
                            <option value="Nightwear (Gowns & Bonnets)" ${product.type === 'Nightwear (Gowns & Bonnets)' ? 'selected' : ''}>Nightwear (Gowns & Bonnets)</option>
                            <option value="Other" ${!['Blouses', 'Bras', 'Cargo Shorts', 'Chinos', 'Dresses', 'Formal Shirts', 'Formal Shoes', 'Formal Trousers', 'Gym Tights', 'Hoodies', 'Jackets', 'Jean Jackets', 'Jeans', 'Jerseys', 'Normal Jackets', 'Sandals', 'Shorts', 'Skirts', 'Socks', 'Sport Jerseys', 'Swimming Shorts', 'T-shirts', 'Trackpants', 'Tracksuits', 'All Tight Types', 'Nightwear (Gowns & Bonnets)'].includes(product.type) ? 'selected' : ''}>Other (Custom Type)</option>
                        </select>
                        <input type="text" id="editTypeCustom" value="${!['Blouses', 'Bras', 'Cargo Shorts', 'Chinos', 'Dresses', 'Formal Shirts', 'Formal Shoes', 'Formal Trousers', 'Gym Tights', 'Hoodies', 'Jackets', 'Jean Jackets', 'Jeans', 'Jerseys', 'Normal Jackets', 'Sandals', 'Shorts', 'Skirts', 'Socks', 'Sport Jerseys', 'Swimming Shorts', 'T-shirts', 'Trackpants', 'Tracksuits', 'All Tight Types', 'Nightwear (Gowns & Bonnets)'].includes(product.type) ? product.type : ''}" placeholder="Enter custom product type..." style="font-size: 1rem; padding: 0.75rem; margin-top: 0.5rem; border: 1px solid var(--silver); width: 100%; ${!['Blouses', 'Bras', 'Cargo Shorts', 'Chinos', 'Dresses', 'Formal Shirts', 'Formal Shoes', 'Formal Trousers', 'Gym Tights', 'Hoodies', 'Jackets', 'Jean Jackets', 'Jeans', 'Jerseys', 'Normal Jackets', 'Sandals', 'Shorts', 'Skirts', 'Socks', 'Sport Jerseys', 'Swimming Shorts', 'T-shirts', 'Trackpants', 'Tracksuits', 'All Tight Types', 'Nightwear (Gowns & Bonnets)'].includes(product.type) ? 'display: block;' : 'display: none;'}">
                        <small style="display: block; margin-top: 0.5rem; color: var(--dark-silver); font-weight: 600;">
                            <i class="fas fa-info-circle"></i> Select an existing type to group with similar products.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Price (R)</label>
                        <input type="number" id="editPrice" value="${product.price}" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="editDescription" rows="3">${product.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Stock Number</label>
                        <input type="text" id="editStockNumber" value="${product.stockNumber || ''}">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;

            document.getElementById('editFormContainer').innerHTML = editForm;
            document.getElementById('editModal').classList.add('active');

            // Handle edit type dropdown change
            const editTypeSelect = document.getElementById('editType');
            const editTypeCustom = document.getElementById('editTypeCustom');
            if (editTypeSelect && editTypeCustom) {
                editTypeSelect.addEventListener('change', function() {
                    if (this.value === '' || this.value === 'Other') {
                        editTypeCustom.style.display = 'block';
                        editTypeCustom.required = true;
                    } else {
                        editTypeCustom.style.display = 'none';
                        editTypeCustom.required = false;
                    }
                });
            }

            document.getElementById('editProductForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Get and validate category FIRST
                const selectedCategory = document.getElementById('editCategory').value.trim().toLowerCase();
                
                if (!selectedCategory || selectedCategory === '') {
                    showAlert('Please select a category (Men\'s, Women\'s, or Kids) before saving', 'error');
                    document.getElementById('editCategory').focus();
                    document.getElementById('editCategory').style.borderColor = '#ff4444';
                    setTimeout(() => {
                        document.getElementById('editCategory').style.borderColor = '';
                    }, 3000);
                    return;
                }
                
                if (!['men', 'women', 'kids'].includes(selectedCategory)) {
                    showAlert('Invalid category selected. Please choose Men\'s, Women\'s, or Kids Collection', 'error');
                    return;
                }

                // Get and validate product type (from dropdown or custom input)
                const editTypeSelect = document.getElementById('editType');
                const editTypeCustom = document.getElementById('editTypeCustom');
                let productType = editTypeSelect.value.trim();
                
                // If custom input is visible and filled, use that instead
                if (editTypeCustom && editTypeCustom.style.display !== 'none' && editTypeCustom.value.trim()) {
                    productType = editTypeCustom.value.trim();
                }
                
                if (!productType || productType === '') {
                    showAlert('Please select or enter a product type before saving', 'error');
                    (editTypeCustom && editTypeCustom.style.display !== 'none' ? editTypeCustom : editTypeSelect).focus();
                    (editTypeCustom && editTypeCustom.style.display !== 'none' ? editTypeCustom : editTypeSelect).style.borderColor = '#ff4444';
                    setTimeout(() => {
                        (editTypeCustom && editTypeCustom.style.display !== 'none' ? editTypeCustom : editTypeSelect).style.borderColor = '';
                    }, 3000);
                    return;
                }
                
                const imageInput = document.getElementById('editProductImage');
                const oldProduct = isDefault 
                    ? productManager.getProductById(productId)
                    : JSON.parse(localStorage.getItem('products') || '[]').find(p => p.id === productId);
                const oldImagePath = oldProduct ? (oldProduct.image || oldProduct.imageURL) : null;
                
                const updatedData = {
                    category: selectedCategory, // Use normalized lowercase category
                    type: productType, // Use trimmed product type
                    price: parseFloat(document.getElementById('editPrice').value),
                    description: document.getElementById('editDescription').value,
                    stockNumber: document.getElementById('editStockNumber').value.trim() || ''
                };
                
                // Log the category and type being saved
                console.log('Updating product:', {
                    category: selectedCategory,
                    type: updatedData.type,
                    productId: productId,
                    willAppearOn: `product-type.html?type=${encodeURIComponent(updatedData.type)}&category=${selectedCategory}`
                });
                
                // Handle new image upload
                if (imageInput.files[0]) {
                    // Validate file type
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                    const file = imageInput.files[0];
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    
                    if (!allowedTypes.includes(file.type) && !['jpg', 'jpeg', 'png', 'webp'].includes(fileExtension)) {
                        showAlert('Invalid file type. Only JPG, JPEG, PNG, and WEBP images are allowed.', 'error');
                        return;
                    }

                    // Show loading
                    const submitBtn = document.querySelector('#editProductForm button[type="submit"]');
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                    try {
                        // Upload new image
                        // Use upload handler
                        const result = await uploadHandler.upload(file);

                        // Delete old image if it exists and is different
                        if (oldImagePath && oldImagePath.includes('Assets/') && oldImagePath !== result.path && !oldImagePath.startsWith('data:')) {
                            await deleteImage(oldImagePath);
                        }

                        // Update with new image path (already handles base64 if needed)
                        const imagePath = result.path; // Either server path or full data URL
                        
                        updatedData.image = imagePath;
                        updatedData.imageURL = imagePath;
                        
                        saveProductChanges(productId, updatedData, isDefault);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    } catch (error) {
                        console.error('Upload error:', error);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        showAlert(`Error uploading image: ${error.message || 'Please try again.'}`, 'error');
                    }
                } else {
                    // No new image - keep existing or keep it empty if it was deleted
                    if (oldImagePath) {
                        updatedData.image = oldImagePath;
                        updatedData.imageURL = oldImagePath;
                    }
                    saveProductChanges(productId, updatedData, isDefault);
                }
            });
        }

        async function saveProductChanges(productId, updatedData, isDefault) {
            try {
                if (isDefault) {
                    await productManager.updateProduct(productId, updatedData);
                } else {
                    // For database products, also update via API
                    await productManager.updateProduct(productId, updatedData);
                }
                
                // Trigger events for cross-tab sync
                window.dispatchEvent(new Event('storage'));
                window.dispatchEvent(new CustomEvent('productsUpdated'));
                
                await loadProducts();
                closeEditModal();
                showAlert('Product updated successfully!', 'success');
            } catch (error) {
                console.error('Error saving product changes:', error);
                showAlert('Error updating product: ' + error.message, 'error');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        /**
         * Delete an image from the server
         * @param {string} imagePath - Path to the image file (e.g., "Assets/uploads/filename.jpg")
         * @returns {Promise<boolean>} - True if deletion successful, false otherwise
         */
        async function deleteImage(imagePath) {
            if (!imagePath || imagePath.startsWith('data:') || !imagePath.includes('Assets/')) {
                // Skip deletion if it's a base64 image or invalid path
                return true;
            }

            try {
                const response = await fetch('admin/delete.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imagePath: imagePath
                    })
                });

                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('Image deleted successfully:', imagePath);
                    return true;
                } else {
                    console.warn('Failed to delete image:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('Error deleting image:', error);
                return false;
            }
        }

        /**
         * Delete only the product image (not the product itself)
         * @param {string} productId - ID of the product
         * @param {string} imagePath - Path to the image file
         * @param {boolean} isDefault - Whether the product is a default product
         */
        async function deleteProductImage(productId, imagePath, isDefault) {
            if (!imagePath || !imagePath.includes('Assets/')) {
                showAlert('Invalid image path. Cannot delete this image.', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete this image from the server?\n\nThe image will be permanently removed, but the product will remain.')) {
                return;
            }

            try {
                // Delete the image from server
                const imageDeleted = await deleteImage(imagePath);
                
                if (imageDeleted) {
                    // Update product to remove image reference
                    const product = await productManager.getProductById(productId);
                    if (product) {
                        // Set image to empty or placeholder - update via API for both default and database products
                        await productManager.updateProduct(productId, { 
                            image: '', 
                            imageURL: '' 
                        });
                    }

                    // Update UI - hide the image in edit modal
                    const editCurrentImage = document.getElementById('editCurrentImage');
                    if (editCurrentImage) {
                        editCurrentImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2RkZCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBEZWxldGVkPC90ZXh0Pjwvc3ZnPg==';
                        editCurrentImage.alt = 'Image deleted';
                    }

                    // Trigger events for cross-tab sync
                    window.dispatchEvent(new Event('storage'));
                    window.dispatchEvent(new CustomEvent('productsUpdated'));
                    
                    showAlert('Image deleted successfully! The product remains but without an image. Upload a new image to replace it.', 'success');
                    
                    // Reload products to refresh display
                    loadProducts();
                } else {
                    showAlert('Failed to delete image from server. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error deleting product image:', error);
                showAlert('Error deleting image. Please try again.', 'error');
            }
        }

        /**
         * Delete a product and its associated image
         * @param {string} productId - ID of the product to delete
         * @param {boolean} isDefault - Whether the product is a default product
         * @param {Event} eventObj - Optional event object for button state updates
         */
        async function deleteProduct(productId, isDefault, eventObj) {
            // Get product info before deletion
            const product = await productManager.getProductById(productId);
            const imagePath = product ? (product.image || product.imageURL) : null;

            if (!confirm('Are you sure you want to delete this product?' + (imagePath ? '\n\nThis will also delete the associated image file from the server.' : ''))) {
                return;
            }

            // Show loading state
            const evt = eventObj || window.event;
            const deleteBtn = evt?.target?.closest('.btn-delete');
            const originalBtnText = deleteBtn?.innerHTML;
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            }

            try {
                // Delete the image from server if it exists
                if (imagePath) {
                    const imageDeleted = await deleteImage(imagePath);
                    if (!imageDeleted) {
                        console.warn('Product deleted but image deletion may have failed:', imagePath);
                    }
                }

                // Delete the product from database
                if (isDefault) {
                    await productManager.deleteProduct(productId, true);
                } else {
                    await productManager.deleteProduct(productId, false);
                }

                // Trigger events for cross-tab sync
                window.dispatchEvent(new Event('storage'));
                window.dispatchEvent(new CustomEvent('productsUpdated'));
                
                loadProducts();
                showAlert('Product deleted successfully!' + (imagePath ? ' Image file also removed from server.' : ''), 'success');
            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Error deleting product. Please try again.', 'error');
            } finally {
                // Restore button state
                if (deleteBtn && originalBtnText) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalBtnText;
                }
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            window.location.href = 'login.html';
        }


        // Add filter event listeners (wait for DOM)
        setTimeout(() => {
            // Set up filter event listeners
            const filterCategory = document.getElementById('filterCategory');
            const filterType = document.getElementById('filterType');
            const filterStock = document.getElementById('filterStock');
            const showOnlyDefault = document.getElementById('showOnlyDefault');
            const showOnlyAdmin = document.getElementById('showOnlyAdmin');
            
            if (filterCategory) {
                filterCategory.addEventListener('change', applyFilters);
            }
            if (filterType) {
                filterType.addEventListener('input', applyFilters);
                filterType.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilters();
                    }
                });
            }
            if (filterStock) {
                filterStock.addEventListener('change', applyFilters);
            }
            const filterRecentlyAdded = document.getElementById('filterRecentlyAdded');
            if (filterRecentlyAdded) {
                filterRecentlyAdded.addEventListener('change', applyFilters);
            }
            if (showOnlyDefault) {
                showOnlyDefault.addEventListener('change', applyFilters);
            }
            if (showOnlyAdmin) {
                showOnlyAdmin.addEventListener('change', applyFilters);
            }
            
            // Listen for storage changes (for same browser cross-tab sync)
            window.addEventListener('storage', () => {
                loadProducts();
            });
            
            // Listen for custom events (for same tab updates)
            window.addEventListener('productsUpdated', () => {
                loadProducts();
            });
            
            // Poll for changes every 5 seconds (for cross-device sync detection)
            // Note: localStorage doesn't sync across devices, but this helps detect manual refreshes
            setInterval(() => {
                const currentProducts = JSON.parse(localStorage.getItem('products') || '[]');
                const currentHash = JSON.stringify(currentProducts.map(p => ({ id: p.id, dateAdded: p.dateAdded })));
                if (window.lastProductsHash !== currentHash) {
                    window.lastProductsHash = currentHash;
                    loadProducts();
                }
            }, 5000);
        }, 100);

        // Note: loadProducts is called in initializeAdmin()
    </script>
</body>
</html>

